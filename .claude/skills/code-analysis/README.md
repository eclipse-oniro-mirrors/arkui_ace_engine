# Code Analysis Skill

ACE Engine 代码分析的专用 Claude Code Skill，提供多层次、场景化的代码分析能力。

## 功能特性

- ✅ **三级分析深度**：快速分析(5-15分钟)、全面分析(30-45分钟)、深度审计(1-2小时)
- ✅ **六种场景化分析**：Bug分析、性能优化、组件设计、API审查、测试分析、安全审计
- ✅ **代码为准原则**：强制要求基于实际代码，禁止猜测和臆造
- ✅ **结构化输出**：可视化图表、代码位置引用、问题分级、可执行建议
- ✅ **知识库集成**：自动交叉验证 `docs/` 下的相关知识库文档
- ✅ **工具链整合**：Glob/Grep/Read 工具验证、编译测试、单元测试执行

## 核心原则

### 1. Code-First Principle（代码为准）
- 始终使用 Read/Grep 工具验证实际源代码
- 所有结论必须标注 `file:line` 格式的代码位置
- 禁止猜测或编造代码实现

### 2. Evidence-Based Analysis（基于证据）
- 每个结论都有实际代码支撑
- 提供完整的代码路径和行号引用
- 标注不确定内容为"推测"

### 3. Structured Output（结构化输出）
- 可视化图表（类继承关系、调用流程、数据流向）
- 问题按严重程度分级
- 具体可执行的改进建议

## 分析级别

### Level 1: 快速分析（基础版本）
- **时间**: 5-15 分钟
- **适用**: 快速问题诊断、简单代码理解、初步评估
- **输出**: 核心发现（带代码引用）、潜在问题、改进建议

### Level 2: 全面分析（完整版本）
- **时间**: 30-45 分钟
- **适用**: 代码审查、架构重构、全面技术评估
- **输出**:
  - 代码位置引用（`file:line`）
  - 实际代码片段
  - 可视化图表（类继承关系、函数调用流程、数据流向图）
  - 问题清单（按严重程度分级）
  - 改进建议（具体可执行）
- **分析维度**:
  - 架构设计（Pattern/Model/Property 分离、NG 架构规范、生命周期）
  - 内存安全（智能指针、裸指针使用、内存泄漏风险）
  - 性能考量（拷贝开销、复杂度、布局/渲染性能）
  - 错误处理（空指针检查、边界条件、异常处理）
  - 测试覆盖（单元测试、关键路径、边界条件）

### Level 3: 深度审计（深度审计）
- **时间**: 1-2 小时
- **适用**: 完整审计、测试验证、性能分析
- **包含**: Level 2 全部内容 + 测试执行 + 性能基准测试 + 安全漏洞评估

## 场景化分析

### 🐛 Bug 分析专用
- **触发关键词**: "分析 Bug"、"定位错误"、"修复缺陷"、"问题排查"
- **输出格式**:
  - Bug 位置（精确到行号）
  - 根本原因分析（Root Cause）
  - 影响范围评估
  - 修复方案（带代码示例）
  - 验证方法

### 🚀 性能优化专用
- **触发关键词**: "性能分析"、"性能优化"、"瓶颈分析"、"优化方案"
- **分析目标**:
  - 布局性能
  - 渲染性能
  - 内存占用
  - CPU 使用率
  - 启动时间
- **输出格式**: 问题点 + 当前复杂度 + 优化方案 + 预期收益

### 📝 新组件开发专用
- **触发关键词**: "设计组件"、"组件架构"、"开发规范"、"组件指导"
- **设计清单**:
  - Pattern 层设计
  - Model 接口定义
  - Layout Property
  - Paint Property
  - Event Hub
  - 测试用例

### 🔍 API 审查专用
- **触发关键词**: "API 审查"、"API 设计"、"接口规范"、"API 评审"
- **审查维度**:
  - API 命名规范
  - 参数设计合理性
  - 返回值类型
  - TypeScript 类型定义
  - 文档完整性（JSDoc）
  - 使用示例

### 🧪 测试分析专用
- **触发关键词**: "测试覆盖"、"测试分析"、"测试用例"、"单元测试"
- **分析内容**:
  - 现有单元测试文件
  - 测试用例数量
  - 覆盖的关键路径
  - 缺失的测试场景
  - 边界条件测试

## 使用方法

### 在对话中触发

直接向 Claude 提出请求：

```
# 快速分析
"分析 TextPattern 的 OnModifyDone 方法"
"快速查看 Menu 组件的生命周期管理"

# 全面分析
"全面分析 Grid 组件的架构设计"
"审查 Text 组件的内存管理策略"

# 场景化分析
"分析这个 Bug：Menu 组件在滚动时崩溃"
"优化 Text 组件的布局性能"
"为新的 XXX 组件提供设计指导"
"审查这个 API 的设计合理性"
"分析 Checkbox 的测试覆盖情况"

# 深度审计
"深度审计 Button 组件的完整实现"
```

### 自动触发条件

当用户提出以下请求时，Claude 会自动调用此 Skill：
- "分析代码"、"代码审查"
- "查看组件"、"分析组件"
- "Bug 分析"、"定位问题"
- "性能优化"、"性能分析"
- "组件设计"、"架构设计"
- "API 审查"、"API 设计"
- "测试分析"、"测试覆盖"
- 提及具体的组件名（Text, Menu, Grid, List, Button 等）

## 目录结构

```
code-analysis/
├── SKILL.md                              # Skill 主文件（核心内容）
├── README.md                             # 本文件
├── examples/                             # 分析示例（待补充）
│   ├── quick-analysis.md                 # 快速分析示例
│   ├── comprehensive-analysis.md         # 全面分析示例
│   └── bug-analysis.md                   # Bug 分析示例
└── references/                           # 参考文档（待补充）
    ├── tools-usage.md                    # 工具使用指南
    ├── quality-checklist.md              # 质量检查清单
    └── output-templates.md               # 输出模板
```

## 工具使用建议

### 文件搜索
```bash
# 使用 Glob 查找文件
Glob: "**/*pattern.cpp"

# 使用 Grep 搜索代码
Grep: "OnModifyDone" --type cpp
```

### 代码验证
```bash
# 验证文件存在
Read: frameworks/core/components_ng/pattern/text/text_pattern.cpp

# 查看特定行
Read: file.cpp (offset: 100, limit: 50)
```

### 编译测试
```bash
# 编译检查
./build.sh --product-name rk3568 --build-target ace_engine

# 运行测试
./out/rk3568/tests/ace_engine/unittest/components_ng/text/text_pattern_test
```

## 质量检查清单

在提交分析结果前，确认：

- [ ] 所有代码引用都标注了 `file:line`
- [ ] 所有结论都有实际代码支撑
- [ ] 没有使用"推测"、"可能"等不确定词汇（或明确标注）
- [ ] 提供了具体可执行的改进建议
- [ ] 包含了可视化图表（如适用）
- [ ] 交叉验证了相关知识库文档
- [ ] 检查了相关组件的实现模式

## 知识库集成

**分析前先查询** `docs/` 下的知识库：
- 组件知识库 (`docs/pattern/*/`)
- 架构文档 (`docs/architecture/`)
- 最佳实践 (`docs/best_practices/`)

**交叉验证**：
- 对比文档与实际代码
- 发现不一致时及时更新文档
- 引用知识库中的代码位置

## 分析模板选择指南

| 任务类型 | 推荐模板 | 预计时间 |
|---------|---------|---------|
| 快速问题诊断 | Level 1: 快速分析 | 5-15 分钟 |
| 代码审查/重构 | Level 2: 全面分析 | 30-45 分钟 |
| Bug 修复 | Bug 分析版本 | 15-30 分钟 |
| 性能优化 | 性能分析版本 | 30-60 分钟 |
| 新组件开发 | 组件设计版本 | 设计阶段使用 |
| API 设计评审 | API 审查版本 | 15-30 分钟 |
| 测试补充 | 测试分析版本 | 20-40 分钟 |
| 完整审计 | Level 3: 深度审计 | 1-2 小时 |

## Skill 特性

### 渐进式加载

1. **Metadata** - 始终加载（本 README）
2. **SKILL.md** - 触发时加载（核心内容）
3. **References** - 按需加载（详细文档）

### 智能触发

基于用户请求的关键词和上下文自动触发此 Skill，无需显式调用。

## 开发者信息

- **位置**: `ace_engine/.claude/skills/code-analysis/`
- **版本**: 1.0.0
- **参考文档**: `docs/CODE_ANALYSIS_PROMPT.md`
- **适用范围**: ACE Engine (OpenHarmony ArkUI) 代码分析

## 更新日志

### v1.0.0 (2026-02-05)
- ✅ 初始版本
- ✅ 三级分析深度（快速、全面、深度审计）
- ✅ 六种场景化分析（Bug、性能、组件设计、API、测试、安全）
- ✅ 代码为准原则
- ✅ 结构化输出规范
- ✅ 知识库集成机制
- ✅ 工具链整合（Glob/Grep/Read/编译/测试）

## 待办事项

- [ ] 添加分析示例到 `examples/` 目录
- [ ] 创建参考文档到 `references/` 目录
- [ ] 创建自动化质量检查脚本
- [ ] 添加更多场景化分析模板（如：安全审计、兼容性分析）
