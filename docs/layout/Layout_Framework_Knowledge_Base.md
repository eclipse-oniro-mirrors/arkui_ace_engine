# Layout Framework çŸ¥è¯†åº“

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **æ›´æ–°æ—¶é—´**: 2026-02-26
> **æºç ç‰ˆæœ¬**: OpenHarmony ace_engine (master åˆ†æ”¯)

---

## ğŸ“š ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [ç›®å½•ç»“æ„](#ç›®å½•ç»“æ„)
3. [æ ¸å¿ƒç±»ç»§æ‰¿å…³ç³»](#æ ¸å¿ƒç±»ç»§æ‰¿å…³ç³»)
4. [å¸ƒå±€æµç¨‹è¯¦è§£](#å¸ƒå±€æµç¨‹è¯¦è§£)
5. [å…³é”®å‡½æ•°è°ƒç”¨é“¾](#å…³é”®å‡½æ•°è°ƒç”¨é“¾)
6. [æ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#æ€§èƒ½ä¼˜åŒ–ç­–ç•¥)
7. [è°ƒè¯•æŒ‡å—](#è°ƒè¯•æŒ‡å—)
8. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## æ¦‚è¿°

### å¸ƒå±€ç³»ç»Ÿå®šä½

**Layout Flow (å¸ƒå±€æµç¨‹)** æ˜¯ OpenHarmony ACE Engine çš„æ ¸å¿ƒå­ç³»ç»Ÿ,è´Ÿè´£è®¡ç®—å’Œæ›´æ–° UI ç»„ä»¶çš„å°ºå¯¸ä¸ä½ç½®ã€‚å¸ƒå±€ç³»ç»Ÿä»å‚ç›´åŒæ­¥ä¿¡å·è§¦å‘å¼€å§‹,é€šè¿‡ä»»åŠ¡è°ƒåº¦ã€èŠ‚ç‚¹æµ‹é‡ã€å¸ƒå±€è®¡ç®—ã€å®‰å…¨åŒºåŸŸæ‰©å±•,æœ€ç»ˆå°†å‡ ä½•æ•°æ®åŒæ­¥åˆ° Rosen æ¸²æŸ“å¼•æ“,å½¢æˆå®Œæ•´çš„å¸ƒå±€è®¡ç®—ç®¡é“ã€‚

### æŠ€æœ¯æ¶æ„

**åˆ†å±‚è®¾è®¡**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PipelineContext (ç®¡é“ä¸Šä¸‹æ–‡)                 â”‚
â”‚  - FlushVsync è§¦å‘                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  UITaskScheduler (ä»»åŠ¡è°ƒåº¦å™¨)                 â”‚
â”‚  - ä»»åŠ¡è°ƒåº¦å’Œç®¡ç†                             â”‚
â”‚  - dirty èŠ‚ç‚¹æ”¶é›†                             â”‚
â”‚  - æ‰¹é‡ä»»åŠ¡æ‰§è¡Œ                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FrameNode (ç»„ä»¶èŠ‚ç‚¹)                         â”‚
â”‚  - Measure æµ‹é‡                               â”‚
â”‚  - Layout å¸ƒå±€                                â”‚
â”‚  - OnLayoutFinish å®Œæˆå¤„ç†                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LayoutAlgorithm (å¸ƒå±€ç®—æ³•)                   â”‚
â”‚  - Measure æµ‹é‡å®ç°                           â”‚
â”‚  - Layout å¸ƒå±€å®ç°                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LayoutWrapper (å¸ƒå±€åŒ…è£…å™¨)                   â”‚
â”‚  - SafeArea å®‰å…¨åŒºåŸŸå¤„ç†                      â”‚
â”‚  - Keyboard é”®ç›˜é¿è®©                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RosenRenderContext (æ¸²æŸ“ä¸Šä¸‹æ–‡)              â”‚
â”‚  - SyncGeometryProperties åŒæ­¥               â”‚
â”‚  - SavePaintRect ä¿å­˜ç»˜åˆ¶åŒºåŸŸ                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒç‰¹æ€§**:
- **å¼‚æ­¥ä»»åŠ¡è°ƒåº¦**: æ”¯æŒå¤šçº¿ç¨‹å¸ƒå±€è®¡ç®—,æå‡æ€§èƒ½
- **å¢é‡æ›´æ–°**: åªå¤„ç† dirty æ ‡è®°çš„èŠ‚ç‚¹,å‡å°‘è®¡ç®—é‡
- **å®‰å…¨åŒºåŸŸé€‚é…**: æ”¯æŒç³»ç»Ÿå®‰å…¨åŒºåŸŸ(åˆ˜æµ·å±ã€åœ†è§’ç­‰)å’Œé”®ç›˜é¿è®©
- **å‡ ä½•èŠ‚ç‚¹åŒæ­¥**: å¸ƒå±€ç»“æœè‡ªåŠ¨åŒæ­¥åˆ° Rosen æ¸²æŸ“å¼•æ“
- **å¤šè½®å¸ƒå±€æ”¯æŒ**: æ”¯æŒå‡ ä½•è¿‡æ¸¡åŠ¨ç”»ç­‰å¤šè½®å¸ƒå±€åœºæ™¯

### ä»£ç è§„æ¨¡

| æ¨¡å— | æ–‡ä»¶ | ä»£ç è¡Œæ•°(ä¼°è®¡) | ä½œç”¨ |
|------|------|---------------|------|
| ä»»åŠ¡è°ƒåº¦ | `ui_task_scheduler.cpp` | ~500 è¡Œ | ä»»åŠ¡è°ƒåº¦å’Œç®¡ç† |
| èŠ‚ç‚¹å¸ƒå±€ | `frame_node.cpp` | ~3500 è¡Œ | ç»„ä»¶èŠ‚ç‚¹å¸ƒå±€å®ç° |
| å¸ƒå±€åŒ…è£… | `layout_wrapper.cpp` | ~850 è¡Œ | å¸ƒå±€æ•°æ®åŒ…è£…å’Œä¼ é€’ |
| å¸ƒå±€ç®—æ³• | `layout_algorithm.cpp` | ~150 è¡Œ | å¸ƒå±€ç®—æ³•åŸºç¡€å®ç° |

---

## ç›®å½•ç»“æ„

### æºç ç»„ç»‡

```
ace_engine/
â”œâ”€â”€ frameworks/
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ components_ng/
â”‚   â”‚   â”‚   â”œâ”€â”€ base/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ frame_node.cpp                    # å¸§èŠ‚ç‚¹,å¸ƒå±€æ‰§è¡Œä¸»ä½“
â”‚   â”‚   â”‚   â”œâ”€â”€ layout/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ layout_wrapper.cpp                # å¸ƒå±€åŒ…è£…å™¨
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ layout_algorithm.cpp              # å¸ƒå±€ç®—æ³•åŸºç¡€
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ layout_algorithm.h                # å¸ƒå±€ç®—æ³•æ¥å£
â”‚   â”‚   â”‚   â”œâ”€â”€ manager/safe_area/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ safe_area_manager.cpp             # å®‰å…¨åŒºåŸŸç®¡ç†å™¨
â”‚   â”‚   â”‚   â””â”€â”€ pattern/
â”‚   â”‚   â”‚       â””â”€â”€ [å„ç»„ä»¶]/
â”‚   â”‚   â”‚           â””â”€â”€ *_layout_algorithm.cpp        # å„ç»„ä»¶å¸ƒå±€ç®—æ³•
â”‚   â”‚   â””â”€â”€ pipeline_ng/
â”‚   â”‚       â”œâ”€â”€ ui_task_scheduler.cpp                  # UIä»»åŠ¡è°ƒåº¦å™¨
â”‚   â”‚       â””â”€â”€ pipeline_context.cpp                  # ç®¡é“ä¸Šä¸‹æ–‡
â”‚   â””â”€â”€ ...
â””â”€â”€ ...
```

### æ ¸å¿ƒæ–‡ä»¶è¯´æ˜

#### 1. UITaskScheduler
**è·¯å¾„**: `frameworks/core/pipeline_ng/ui_task_scheduler.cpp`

**èŒè´£**:
- ç®¡ç†å¸ƒå±€å’Œæ¸²æŸ“ä»»åŠ¡çš„è°ƒåº¦
- æ”¶é›† dirty èŠ‚ç‚¹
- æ‰¹é‡æ‰§è¡Œå¸ƒå±€å’ŒåŒæ­¥ä»»åŠ¡
- åè°ƒä»»åŠ¡æ‰§è¡Œé¡ºåº

**å…³é”®ç±»**:
```cpp
class UITaskScheduler {
    std::vector<RefPtr<FrameNode>> dirtyLayoutNodes_;     // dirty å¸ƒå±€èŠ‚ç‚¹
    std::map<int32_t, PageDirtySet> dirtyRenderNodes_;   // dirty æ¸²æŸ“èŠ‚ç‚¹
    std::vector<std::function<void()>> syncGeometryNodeTasks_; // åŒæ­¥ä»»åŠ¡é˜Ÿåˆ—

    void FlushTask();                    // ä¸»ä»»åŠ¡æ‰§è¡Œå‡½æ•°
    void FlushLayoutTask();              // åˆ·æ–°å¸ƒå±€ä»»åŠ¡
    void FlushSyncGeometryNodeTasks();   // åˆ·æ–°å‡ ä½•èŠ‚ç‚¹åŒæ­¥ä»»åŠ¡
    void FlushRenderTask();              // åˆ·æ–°æ¸²æŸ“ä»»åŠ¡
};
```

#### 2. FrameNode
**è·¯å¾„**: `frameworks/core/components_ng/base/frame_node.cpp`

**èŒè´£**:
- ç»„ä»¶èŠ‚ç‚¹çš„å¸ƒå±€æ‰§è¡Œä¸»ä½“
- æµ‹é‡å’Œå¸ƒå±€çš„ä¸»è¦æ‰§è¡Œè€…
- å¸ƒå±€å®Œæˆåçš„å›è°ƒå¤„ç†
- å‡ ä½•èŠ‚ç‚¹åŒæ­¥

**å…³é”®æ–¹æ³•**:
```cpp
class FrameNode : public UINode {
    void CreateLayoutTask(bool forceUseMainThread, LayoutType layoutTaskType);
    void Measure(const std::optional<LayoutConstraintF>& parentConstraint);
    void Layout();
    bool OnLayoutFinish(bool& needSyncRsNode, DirtySwapConfig& config);
    void SyncGeometryNode(bool needSyncRsNode, const DirtySwapConfig& config);

    RefPtr<LayoutAlgorithmWrapper> GetLayoutAlgorithm(bool needReset);
    LayoutConstraintF GetLayoutConstraint() const;
};
```

#### 3. LayoutWrapper
**è·¯å¾„**: `frameworks/core/components_ng/layout/layout_wrapper.cpp`

**èŒè´£**:
- å¸ƒå±€æ•°æ®çš„åŒ…è£…å’Œä¼ é€’
- å®‰å…¨åŒºåŸŸæ‰©å±•å¤„ç†
- é”®ç›˜é¿è®©å¤„ç†
- å¸ƒå±€çº¦æŸåº”ç”¨

**å…³é”®æ–¹æ³•**:
```cpp
class LayoutWrapper {
    void ApplyConstraint(LayoutConstraintF constraint);
    void ExpandSafeArea();
    bool AvoidKeyboard(bool isFocusOnPage);
    OffsetF GetParentGlobalOffsetWithSafeArea() const;
    RectF GetFrameRectWithSafeArea() const;
};
```

#### 4. LayoutAlgorithm
**è·¯å¾„**: `frameworks/core/components_ng/layout/layout_algorithm.cpp`

**èŒè´£**:
- å¸ƒå±€ç®—æ³•çš„åŸºç¡€å®ç°
- Measure å’Œ Layout çš„åŒ…è£…å™¨å±‚

**å…³é”®æ–¹æ³•**:
```cpp
class LayoutAlgorithm {
    virtual void Measure(LayoutWrapper* layoutWrapper) = 0;
    virtual void Layout(LayoutWrapper* layoutWrapper) = 0;
};

class LayoutAlgorithmWrapper {
    void Measure(LayoutWrapper* layoutWrapper);
    void Layout(LayoutWrapper* layoutWrapper);
};
```

---

## æ ¸å¿ƒç±»ç»§æ‰¿å…³ç³»

### å¸ƒå±€ç›¸å…³ç±»ç»§æ‰¿å›¾

```
UINode
  â”‚
  â”œâ”€ FrameNode (ç»„ä»¶èŠ‚ç‚¹)
  â”‚    â”‚
  â”‚    â”œâ”€ pattern_: Pattern (ä¸šåŠ¡é€»è¾‘)
  â”‚    â”œâ”€ layoutProperty_: LayoutProperty (å¸ƒå±€å±æ€§)
  â”‚    â”œâ”€ geometryNode_: GeometryNode (å‡ ä½•æ•°æ®)
  â”‚    â”œâ”€ renderContext_: RenderContext (æ¸²æŸ“ä¸Šä¸‹æ–‡)
  â”‚    â””â”€ layoutAlgorithm_: LayoutAlgorithmWrapper (å¸ƒå±€ç®—æ³•)
  â”‚
  â””â”€ ...

LayoutAlgorithm (å¸ƒå±€ç®—æ³•åŸºç±»)
  â”‚
  â”œâ”€ FlexLayoutAlgorithm (å¼¹æ€§å¸ƒå±€)
  â”œâ”€ GridLayoutAlgorithm (ç½‘æ ¼å¸ƒå±€)
  â”œâ”€ ScrollLayoutAlgorithm (æ»šåŠ¨å¸ƒå±€)
  â””â”€ ... (å„ç»„ä»¶çš„å¸ƒå±€ç®—æ³•)

LayoutWrapper (å¸ƒå±€åŒ…è£…å™¨)
  â”‚
  â””â”€ LayoutWrapperNode (èŠ‚ç‚¹åŒ…è£…å™¨)
       â”‚
       â”œâ”€ hostNode_: FrameNode (å®¿ä¸»èŠ‚ç‚¹)
       â”œâ”€ geometryNode_: GeometryNode (å‡ ä½•èŠ‚ç‚¹)
       â””â”€ layoutProperty_: LayoutProperty (å¸ƒå±€å±æ€§)
```

### å…³é”®æ•°æ®ç»“æ„

#### LayoutConstraintF (å¸ƒå±€çº¦æŸ)
```cpp
struct LayoutConstraintF {
    OptionalSizeF minSize;           // æœ€å°å°ºå¯¸
    OptionalSizeF maxSize;           // æœ€å¤§å°ºå¯¸
    OptionalSizeF percentReference;  // ç™¾åˆ†æ¯”å‚è€ƒå°ºå¯¸
    ScaleProperty scaleProperty;     // ç¼©æ”¾å±æ€§
};
```

#### DirtySwapConfig (å˜åŒ–é…ç½®)
```cpp
struct DirtySwapConfig {
    bool frameSizeChange;      // æ¡†æ¶å°ºå¯¸æ˜¯å¦å˜åŒ–
    bool frameOffsetChange;    // æ¡†æ¶ä½ç½®æ˜¯å¦å˜åŒ–
    bool contentSizeChange;    // å†…å®¹å°ºå¯¸æ˜¯å¦å˜åŒ–
    bool contentOffsetChange;  // å†…å®¹ä½ç½®æ˜¯å¦å˜åŒ–
    bool skipMeasure;          // æ˜¯å¦è·³è¿‡æµ‹é‡
    bool skipLayout;           // æ˜¯å¦è·³è¿‡å¸ƒå±€
};
```

#### SafeAreaExpandOpts (å®‰å…¨åŒºåŸŸæ‰©å±•é€‰é¡¹)
```cpp
struct SafeAreaExpandOpts {
    LayoutSafeAreaType type;   // æ‰©å±•ç±»å‹(ç³»ç»Ÿ/é”®ç›˜ç­‰)
    LayoutSafeAreaEdge edges;  // æ‰©å±•è¾¹(ä¸Š/ä¸‹/å·¦/å³)
    bool switchToNone;         // æ˜¯å¦åˆ‡æ¢åˆ°æ— æ‰©å±•

    bool Expansive() const;    // æ˜¯å¦éœ€è¦æ‰©å±•
    bool ExpansiveToKeyboard() const; // æ˜¯å¦æ‰©å±•åˆ°é”®ç›˜
};
```

---

## å¸ƒå±€æµç¨‹è¯¦è§£

### å®Œæ•´æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. PipelineContext::FlushVsync                              â”‚
â”‚    æ¥æ”¶å‚ç›´åŒæ­¥ä¿¡å·,è§¦å‘ UI åˆ·æ–°                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. UITaskScheduler::FlushTask                               â”‚
â”‚    åè°ƒå¸ƒå±€å’Œæ¸²æŸ“ä»»åŠ¡çš„æ‰§è¡Œé¡ºåº                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. UITaskScheduler::FlushLayoutTask                         â”‚
â”‚    æ‰¹é‡æ‰§è¡Œæ‰€æœ‰ dirty å¸ƒå±€èŠ‚ç‚¹                                â”‚
â”‚    - æ”¶é›† dirty èŠ‚ç‚¹                                         â”‚
â”‚    - ä¸ºæ¯ä¸ªèŠ‚ç‚¹åˆ›å»ºå¸ƒå±€ä»»åŠ¡                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚                                         â”‚
                         â–¼                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. FrameNode::CreateLayoutTask   â”‚             â”‚ å…¶ä»– dirty èŠ‚ç‚¹               â”‚
â”‚    - æ›´æ–°å¸ƒå±€å±æ€§æ ‡å¿—              â”‚             â”‚ ...                           â”‚
â”‚    - è·å–å¸ƒå±€çº¦æŸ                  â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚                  â”‚
             â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. FrameNode::Measure   â”‚  â”‚ 6. FrameNode::Layout         â”‚
â”‚    æµ‹é‡é˜¶æ®µ              â”‚  â”‚    å¸ƒå±€é˜¶æ®µ                   â”‚
â”‚    â”œâ”€ åº”ç”¨çº¦æŸ           â”‚  â”‚    â”œâ”€ è°ƒæ•´å®‰å…¨åŒºåŸŸ            â”‚
â”‚    â”œâ”€ æµ‹é‡å†…å®¹           â”‚  â”‚    â”œâ”€ æ‰§è¡Œå¸ƒå±€ç®—æ³•            â”‚
â”‚    â”œâ”€ æ‰§è¡Œç®—æ³•           â”‚  â”‚    â”œâ”€ å¸ƒå±€å®Œæˆå¤„ç†            â”‚
â”‚    â””â”€ åº”ç”¨å®½é«˜æ¯”         â”‚  â”‚    â””â”€ æ·»åŠ åŒæ­¥ä»»åŠ¡            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                            â”‚
         â”‚                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                            â”‚                                â”‚
         â–¼                            â–¼                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MeasureContent  â”‚       â”‚ ç®—æ³•å¸ƒå±€          â”‚       â”‚ OnLayoutFinish       â”‚
â”‚ æµ‹é‡å†…å®¹å°ºå¯¸     â”‚       â”‚ æ’åˆ—å­ç»„ä»¶        â”‚       â”‚ å®Œæˆå›è°ƒ              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚                        â”‚
                                      â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                      â”‚                        â”‚             â”‚
                                      â–¼                        â–¼             â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚ LayoutAlgorithm â”‚    â”‚ SavePaintRectâ”‚  â”‚ MarkDirty    â”‚
                            â”‚ Layout æ–¹æ³•     â”‚    â”‚ ä¿å­˜ç»˜åˆ¶åŒºåŸŸ  â”‚  â”‚ æ ‡è®°é‡ç»˜      â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚ AddSyncTask     â”‚
                            â”‚ æ·»åŠ åŒæ­¥ä»»åŠ¡     â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. UITaskScheduler::FlushSyncGeometryNodeTasks                     â”‚
â”‚    æ‰¹é‡æ‰§è¡Œå‡ ä½•èŠ‚ç‚¹åŒæ­¥ä»»åŠ¡                                           â”‚
â”‚    â”œâ”€ ExpandSafeArea æ‰©å±•å®‰å…¨åŒºåŸŸ                                   â”‚
â”‚    â”œâ”€ SetLayoutNodeRect è®¾ç½®èŠ‚ç‚¹ä½ç½®                                â”‚
â”‚    â””â”€ æ‰§è¡Œæ‰€æœ‰åŒæ­¥ä»»åŠ¡                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚                    â”‚
                         â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. SafeAreaManager           â”‚  â”‚ 9. FrameNode::SyncGeometryNode   â”‚
â”‚    ::ExpandSafeArea          â”‚  â”‚    åŒæ­¥å‡ ä½•èŠ‚ç‚¹                    â”‚
â”‚    æ‰©å±•å®‰å…¨åŒºåŸŸ               â”‚  â”‚    â”œâ”€ åŒæ­¥è¾¹æ¡†å±æ€§                â”‚
â”‚    â””â”€ LayoutWrapper          â”‚  â”‚    â”œâ”€ è§¦å‘ Pattern å›è°ƒ           â”‚
â”‚        ::ExpandSafeArea      â”‚  â”‚    â”œâ”€ åŒæ­¥å‡ ä½•å±æ€§                â”‚
â”‚            æ‰©å±•åˆ°å®‰å…¨åŒºåŸŸ     â”‚  â”‚    â”œâ”€ æ›´æ–°èƒŒæ™¯                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â””â”€ é‡å»ºæ¸²æŸ“æ ‘                  â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                  â”‚
                                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 10. UITaskScheduler::FlushRenderTask                               â”‚
â”‚     æ‰§è¡Œæ¸²æŸ“ä»»åŠ¡(é€æ˜¾é˜¶æ®µ,éå¸ƒå±€æ ¸å¿ƒæµç¨‹)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒå‡½æ•°è°ƒç”¨åºåˆ—

#### æµ‹é‡é˜¶æ®µè°ƒç”¨é“¾

```
FrameNode::Measure (frame_node.cpp:5535)
  â”‚
  â”œâ”€> GetLayoutAlgorithm()           // è·å–å¸ƒå±€ç®—æ³•
  â”‚    â””â”€> pattern_->CreateLayoutAlgorithm()
  â”‚
  â”œâ”€> ApplyConstraint()              // åº”ç”¨å¸ƒå±€çº¦æŸ
  â”‚    â””â”€> layoutProperty_->UpdateLayoutConstraint()
  â”‚
  â”œâ”€> layoutAlgorithm_->MeasureContent()  // æµ‹é‡å†…å®¹å°ºå¯¸
  â”‚    â””â”€> [å…·ä½“ç®—æ³•å®ç°]
  â”‚
  â”œâ”€> layoutAlgorithm_->Measure(this)      // æ‰§è¡Œæµ‹é‡ç®—æ³•
  â”‚    â””â”€> LayoutAlgorithmWrapper::Measure()
  â”‚         â””â”€> layoutAlgorithm_->Measure(layoutWrapper)
  â”‚
  â””â”€> geometryNode_->SetFrameSize()    // è®¾ç½®æ¡†æ¶å°ºå¯¸
```

**å…³é”®æ–‡ä»¶å¼•ç”¨**:
- `frame_node.cpp:5535-5679` - FrameNode::Measure
- `frame_node.cpp:6209-6220` - GetLayoutAlgorithm
- `layout_algorithm.cpp:85-97` - LayoutAlgorithmWrapper::Measure

#### å¸ƒå±€é˜¶æ®µè°ƒç”¨é“¾

```
FrameNode::Layout (frame_node.cpp:5682)
  â”‚
  â”œâ”€> OffsetNodeToSafeArea()        // è°ƒæ•´åˆ°å®‰å…¨åŒºåŸŸ
  â”‚
  â”œâ”€> layoutAlgorithm_->Layout(this)    // æ‰§è¡Œå¸ƒå±€ç®—æ³•
  â”‚    â””â”€> LayoutAlgorithmWrapper::Layout()
  â”‚         â””â”€> layoutAlgorithm_->Layout(layoutWrapper)
  â”‚
  â”œâ”€> OnLayoutFinish()               // å¸ƒå±€å®Œæˆå¤„ç†
  â”‚    â”œâ”€> æ£€æµ‹å°ºå¯¸å˜åŒ–
  â”‚    â”œâ”€> renderContext_->SavePaintRect()  // ä¿å­˜ç»˜åˆ¶åŒºåŸŸ
  â”‚    â”œâ”€> pattern_->OnDirtyLayoutWrapperSwap()  // Pattern å›è°ƒ
  â”‚    â””â”€> MarkDirtyNode()           // æ ‡è®°éœ€è¦é‡ç»˜
  â”‚
  â””â”€> pipeline->AddSyncGeometryNodeTask()  // æ·»åŠ åŒæ­¥ä»»åŠ¡
       â””â”€> ä»»åŠ¡é˜Ÿåˆ—å­˜å‚¨
```

**å…³é”®æ–‡ä»¶å¼•ç”¨**:
- `frame_node.cpp:5682-5789` - FrameNode::Layout
- `frame_node.cpp:5860-5965` - FrameNode::OnLayoutFinish
- `layout_algorithm.cpp:99-108` - LayoutAlgorithmWrapper::Layout

#### åŒæ­¥é˜¶æ®µè°ƒç”¨é“¾

```
UITaskScheduler::FlushSyncGeometryNodeTasks (ui_task_scheduler.cpp:116)
  â”‚
  â”œâ”€> ExpandSafeArea()               // æ‰©å±•å®‰å…¨åŒºåŸŸ
  â”‚    â””â”€> SafeAreaManager::ExpandSafeArea()
  â”‚         â””â”€> LayoutWrapper::ExpandSafeArea()
  â”‚              â”œâ”€> GetParentGlobalOffsetWithSafeArea()  // è·å–çˆ¶èŠ‚ç‚¹åç§»
  â”‚              â”œâ”€> ExpandHelper()                       // æ‰§è¡Œæ‰©å±•
  â”‚              â”œâ”€> AdjustFixedSizeNode()                // è°ƒæ•´å›ºå®šå°ºå¯¸èŠ‚ç‚¹
  â”‚              â”œâ”€> AdjustChildren()                     // è°ƒæ•´å­èŠ‚ç‚¹
  â”‚              â””â”€> renderContext_->UpdatePaintRect()    // æ›´æ–°ç»˜åˆ¶åŒºåŸŸ
  â”‚
  â”œâ”€> SetLayoutNodeRect()           // è®¾ç½®èŠ‚ç‚¹ä½ç½®
  â”‚
  â””â”€> æ‰§è¡Œæ‰€æœ‰åŒæ­¥ä»»åŠ¡
       â””â”€> FrameNode::SyncGeometryNode()  // åŒæ­¥å‡ ä½•èŠ‚ç‚¹
            â”œâ”€> æ›´æ–°è¾¹æ¡†å±æ€§
            â”œâ”€> pattern_->OnSyncGeometryNode()  // Pattern å›è°ƒ
            â”œâ”€> renderContext_->SyncGeometryProperties()  // åŒæ­¥å‡ ä½•å±æ€§
            â”œâ”€> UpdateBackground()       // æ›´æ–°èƒŒæ™¯
            â””â”€> RebuildRenderContextTree()  // é‡å»ºæ¸²æŸ“æ ‘
```

**å…³é”®æ–‡ä»¶å¼•ç”¨**:
- `ui_task_scheduler.cpp:116-127` - FlushSyncGeometryNodeTasks
- `ui_task_scheduler.cpp:107-114` - ExpandSafeArea
- `layout_wrapper.cpp:297-365` - LayoutWrapper::ExpandSafeArea
- `frame_node.cpp:5967-6033` - FrameNode::SyncGeometryNode

---

### ç»„ä»¶æ ‘çš„é€’å½’æ‰§è¡Œé€»è¾‘

å¸ƒå±€ç³»ç»Ÿé€šè¿‡**é€’å½’éå†ç»„ä»¶æ ‘**æ¥å®Œæˆæ‰€æœ‰ç»„ä»¶çš„æµ‹é‡å’Œå¸ƒå±€ã€‚çˆ¶å®¹å™¨åœ¨æ‰§è¡Œ Measure/Layout æ—¶ï¼Œä¼šéå†æ‰€æœ‰å­ç»„ä»¶ï¼Œå¯¹æ¯ä¸ªå­ç»„ä»¶è°ƒç”¨å…¶ Measure/Layout æ–¹æ³•ï¼Œå­ç»„ä»¶åˆä¼šé€’å½’åœ°å¯¹å®ƒçš„å­ç»„ä»¶æ‰§è¡Œç›¸åŒçš„æ“ä½œï¼Œå½¢æˆæ·±åº¦ä¼˜å…ˆçš„éå†ã€‚

#### é€’å½’æ‰§è¡Œçš„ä¸‰å±‚ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FrameNode å±‚ (frame_node.cpp)                               â”‚
â”‚   - è§¦å‘é€’å½’: Measure() / Layout()                          â”‚
â”‚   - è°ƒç”¨ LayoutAlgorithm                                    â”‚
â”‚   - ä¸ç›´æ¥éå†å­ç»„ä»¶                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LayoutAlgorithm å±‚ (flex_layout_algorithm.cpp)              â”‚
â”‚   - éå†å­ç»„ä»¶: GetAllChildrenWithBuild()                   â”‚
â”‚   - åˆ›å»ºçº¦æŸ: CreateChildConstraint()                       â”‚
â”‚   - è§¦å‘å­ç»„ä»¶é€’å½’: child->Measure() / child->Layout()      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LayoutWrapper å±‚ (layout_wrapper_node.cpp)                  â”‚
â”‚   - é€’å½’å…¥å£: Measure() / Layout()                          â”‚
â”‚   - è°ƒç”¨å­ç»„ä»¶çš„ LayoutAlgorithm                            â”‚
â”‚   - å½¢æˆé€’å½’å¾ªç¯                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Measure é˜¶æ®µçš„é€’å½’

**æ‰§è¡Œæµç¨‹**:

```
FlexLayoutAlgorithm::Measure (çˆ¶å®¹å™¨)
  â”‚
  â”œâ”€> 1. è·å–æ‰€æœ‰å­ç»„ä»¶
  â”‚     const auto& children = layoutWrapper->GetAllChildrenWithBuild()
  â”‚
  â”œâ”€> 2. è®¡ç®—çˆ¶å®¹å™¨å°ºå¯¸
  â”‚     realSize = CreateIdealSizeByPercentRef(...)
  â”‚
  â””â”€> 3. éå†å­ç»„ä»¶å¹¶é€’å½’æµ‹é‡
        for (auto& child : children) {
            // åˆ›å»ºå­ç»„ä»¶çº¦æŸ
            childConstraint = CreateChildConstraint()

            // é€’å½’è°ƒç”¨å­ç»„ä»¶ Measure
            child->Measure(childConstraint)
                â”‚
                â””â”€> LayoutWrapperNode::Measure (layout_wrapper_node.cpp:150)
                     â”‚
                     â”œâ”€> ApplyConstraint(childConstraint)  // åº”ç”¨çº¦æŸ
                     â”‚
                     â”œâ”€> layoutAlgorithm_->MeasureContent()  // æµ‹é‡å†…å®¹
                     â”‚
                     â”œâ”€> layoutAlgorithm_->Measure(this)     // æ‰§è¡Œç®—æ³•
                     â”‚     â”‚
                     â”‚     â””â”€> å¦‚æœå­ç»„ä»¶æ˜¯å®¹å™¨: ç»§ç»­é€’å½’éå†å…¶å­ç»„ä»¶
                     â”‚
                     â””â”€> geometryNode_->SetFrameSize()      // è®¾ç½®å°ºå¯¸
        }
```

**ä¾‹ä¸¾æºç ä½ç½®**:
- Flex Measure: `flex_layout_algorithm.cpp:1106-1177`
- Flex é€’å½’è°ƒç”¨: `flex_layout_algorithm.cpp:588-629` (MeasureAndCleanMagicNodes)
- LayoutWrapperNode Measure: `layout_wrapper_node.cpp:150-215`

**Flex çš„å¤šæ¬¡æµ‹é‡åœºæ™¯**:
- **ç¬¬ä¸€è½®**: æµ‹é‡æ—  `layoutWeight` çš„å­ç»„ä»¶
- **è®¡ç®—**: æ ¹æ®å‰©ä½™ç©ºé—´è®¡ç®— `layoutWeight` å­ç»„ä»¶çš„åˆ†é…
- **ç¬¬äºŒè½®**: æµ‹é‡æœ‰ `layoutWeight` çš„å­ç»„ä»¶ï¼Œä½¿ç”¨åˆ†é…çš„ç©ºé—´

#### Layout é˜¶æ®µçš„é€’å½’

**æ‰§è¡Œæµç¨‹**:

```
FlexLayoutAlgorithm::Layout (çˆ¶å®¹å™¨)
  â”‚
  â”œâ”€> 1. è·å–æ‰€æœ‰å­ç»„ä»¶
  â”‚     const auto& children = layoutWrapper->GetAllChildrenWithBuild(false)
  â”‚
  â”œâ”€> 2. è®¡ç®—å¸ƒå±€å‚æ•°
  â”‚     mainAxisSize_ = GetMainAxisSizeHelper(contentSize, direction_)
  â”‚     remainSpace = mainAxisSize_ - allocatedSize_
  â”‚
  â”œâ”€> 3. æ”¾ç½®å­ç»„ä»¶ï¼ˆè®¾ç½®ä½ç½®ï¼‰
  â”‚     PlaceChildren(layoutWrapper, frontSpace, betweenSpace, paddingOffset)
  â”‚     â”‚
  â”‚     â””â”€> å¯¹æ¯ä¸ªå­ç»„ä»¶:
  â”‚          childGeometryNode->SetMarginFrameOffset(offset)
  â”‚
  â””â”€> 4. é€’å½’è°ƒç”¨å­ç»„ä»¶ Layout
        for (auto&& child : children) {
            child->Layout()  // stack_layout_algorithm.cpp:30-32
                â”‚
                â””â”€> LayoutWrapperNode::Layout (layout_wrapper_node.cpp:218)
                     â”‚
                     â”œâ”€> OffsetNodeToSafeArea()  // è°ƒæ•´å®‰å…¨åŒºåŸŸ
                     â”‚
                     â”œâ”€> layoutAlgorithm_->Layout(this)  // æ‰§è¡Œå¸ƒå±€ç®—æ³•
                     â”‚     â”‚
                     â”‚     â””â”€> å¦‚æœå­ç»„ä»¶æ˜¯å®¹å™¨: ç»§ç»­é€’å½’éå†å…¶å­ç»„ä»¶
                     â”‚
                     â””â”€> è¿”å›
        }
```

**ä¾‹ä¸¾æºç ä½ç½®**:
- Flex Layout: `flex_layout_algorithm.cpp:1240-1299`
- Stack Layout: `stack_layout_algorithm.cpp:26-33`
- LayoutWrapperNode Layout: `layout_wrapper_node.cpp:218-249`

#### å…¸å‹ç»„ä»¶é€’å½’å¯¹æ¯”

| ç‰¹æ€§ | Flex | Stack |
|------|------|-------|
| **Measure é€’å½’** | çˆ¶å®¹å™¨éå†å­ç»„ä»¶é€’å½’è°ƒç”¨ | çˆ¶å®¹å™¨ä¸é€’å½’ï¼Œå­ç»„ä»¶ç‹¬ç«‹æµ‹é‡ |
| **Layout é€’å½’** | æ”¾ç½®å­ç»„ä»¶åé€’å½’è°ƒç”¨ | æ”¾ç½®å­ç»„ä»¶åé€’å½’è°ƒç”¨ |
| **çº¦æŸä¼ é€’** | å‘å­ç»„ä»¶ä¼ é€’çº¦æŸ | ä¸ä¼ é€’çº¦æŸ |
| **æµ‹é‡æ¬¡æ•°** | å¯èƒ½å¤šæ¬¡ï¼ˆflexWeightï¼‰ | é€šå¸¸ä¸€æ¬¡ |

#### é€’å½’æ‰§è¡Œç¤ºä¾‹

```
Column (çˆ¶å®¹å™¨)
  â”œâ”€ Text (å­ç»„ä»¶1)
  â”œâ”€ Row (å­ç»„ä»¶2)
  â”‚    â”œâ”€ Button (å­™ç»„ä»¶1)
  â”‚    â””â”€ Image (å­™ç»„ä»¶2)
  â””â”€ Divider (å­ç»„ä»¶3)

Measure é€’å½’é¡ºåº:
1. Column::Measure å¼€å§‹
2.   Text::Measure å¼€å§‹ â†’ ç»“æŸ
3.   Row::Measure å¼€å§‹
4.     Button::Measure å¼€å§‹ â†’ ç»“æŸ
5.     Image::Measure å¼€å§‹ â†’ ç»“æŸ
6.   Row::Measure ç»“æŸ
7.   Divider::Measure å¼€å§‹ â†’ ç»“æŸ
8. Column::Measure ç»“æŸ

Layout é€’å½’é¡ºåº:
1. Column::Layout å¼€å§‹ï¼ˆè®¾ç½®æ‰€æœ‰å­ç»„ä»¶ä½ç½®ï¼‰
2.   Text::Layout å¼€å§‹ â†’ ç»“æŸ
3.   Row::Layout å¼€å§‹ï¼ˆè®¾ç½® Button å’Œ Image ä½ç½®ï¼‰
4.     Button::Layout å¼€å§‹ â†’ ç»“æŸ
5.     Image::Layout å¼€å§‹ â†’ ç»“æŸ
6.   Row::Layout ç»“æŸ
7.   Divider::Layout å¼€å§‹ â†’ ç»“æŸ
8. Column::Layout ç»“æŸ
```

#### é€’å½’æ€§èƒ½ä¼˜åŒ–

1. **SkipMeasure/SkipLayout**: çº¦æŸæœªå˜åŒ–æ—¶è·³è¿‡
2. **å¢é‡å¸ƒå±€**: åªå¯¹å˜åŒ–çš„å­ç»„ä»¶é€’å½’æ‰§è¡Œ
3. **æ‡’æ„å»º**: ä½¿ç”¨ `GetAllChildrenWithBuild(false)` åªè·å–å·²æ„å»ºçš„å­ç»„ä»¶
4. **æµ‹é‡ç¼“å­˜**: ç¼“å­˜å­ç»„ä»¶çš„æµ‹é‡ç»“æœ

---

## å…³é”®å‡½æ•°è°ƒç”¨é“¾

### å®Œæ•´è°ƒç”¨è·¯å¾„

```
PipelineContext::FlushVsync
  â””â”€> UITaskScheduler::FlushTask
      â”œâ”€> UITaskScheduler::FlushLayoutTask
      â”‚   â”œâ”€> FrameNode::CreateLayoutTask
      â”‚   â”‚   â”œâ”€> FrameNode::Measure
      â”‚   â”‚   â”‚   â”œâ”€> FrameNode::GetLayoutAlgorithm
      â”‚   â”‚   â”‚   â”‚   â””â”€> Pattern::CreateLayoutAlgorithm
      â”‚   â”‚   â”‚   â”œâ”€> LayoutAlgorithmWrapper::Measure
      â”‚   â”‚   â”‚   â”‚   â””â”€> LayoutAlgorithm::Measure
      â”‚   â”‚   â”‚   â””â”€> GeometryNode::SetFrameSize
      â”‚   â”‚   â””â”€> FrameNode::Layout
      â”‚   â”‚       â”œâ”€> LayoutAlgorithmWrapper::Layout
      â”‚   â”‚       â”‚   â””â”€> LayoutAlgorithm::Layout
      â”‚   â”‚       â”œâ”€> FrameNode::OnLayoutFinish
      â”‚   â”‚       â”‚   â”œâ”€> RosenRenderContext::SavePaintRect
      â”‚   â”‚       â”‚   â”œâ”€> Pattern::OnDirtyLayoutWrapperSwap
      â”‚   â”‚       â”‚   â””â”€> FrameNode::MarkDirtyNode
      â”‚   â”‚       â””â”€> PipelineContext::AddSyncGeometryNodeTask
      â”‚   â””â”€> UITaskScheduler::FlushSyncGeometryNodeTasks
      â”‚       â”œâ”€> UITaskScheduler::ExpandSafeArea
      â”‚       â”‚   â””â”€> SafeAreaManager::ExpandSafeArea
      â”‚       â”‚       â””â”€> LayoutWrapper::ExpandSafeArea
      â”‚       â””â”€> FrameNode::SyncGeometryNode
      â”‚           â””â”€> RosenRenderContext::SyncGeometryProperties
      â””â”€> UITaskScheduler::FlushRenderTask
```

### å‡½æ•°è§’è‰²å®šä½è¡¨

| å‡½æ•° | å±‚æ¬¡ | è§’è‰²å®šä½ | æ ¸å¿ƒèŒè´£ |
|------|------|----------|----------|
| `FlushVsync` | è§¦å‘å±‚ | æµç¨‹è§¦å‘è€… | æ¥æ”¶å‚ç›´åŒæ­¥ä¿¡å·,å¯åŠ¨åˆ·æ–°æµç¨‹ |
| `FlushTask` | è°ƒåº¦å±‚ | ä»»åŠ¡åè°ƒè€… | åè°ƒå¸ƒå±€å’Œæ¸²æŸ“ä»»åŠ¡çš„æ‰§è¡Œé¡ºåº |
| `FlushLayoutTask` | è°ƒåº¦å±‚ | æ‰¹é‡æ‰§è¡Œè€… | æ‰¹é‡æ‰§è¡Œæ‰€æœ‰ dirty èŠ‚ç‚¹çš„å¸ƒå±€ |
| `CreateLayoutTask` | æ‰§è¡Œå±‚ | ä»»åŠ¡åˆ›å»ºè€… | ä¸ºå•ä¸ªèŠ‚ç‚¹åˆ›å»ºå¸ƒå±€ä»»åŠ¡ |
| `Measure` | æ‰§è¡Œå±‚ | æµ‹é‡æ‰§è¡Œè€… | è®¡ç®—ç»„ä»¶çš„ç†æƒ³å°ºå¯¸ |
| `GetLayoutAlgorithm` | æ‰§è¡Œå±‚ | ç®—æ³•è·å–è€… | è·å–æˆ–åˆ›å»ºå¸ƒå±€ç®—æ³• |
| `LayoutAlgorithm::Measure` | ç®—æ³•å±‚ | æµ‹é‡ç®—æ³• | å…·ä½“çš„æµ‹é‡ç®—æ³•å®ç° |
| `Layout` | æ‰§è¡Œå±‚ | å¸ƒå±€æ‰§è¡Œè€… | è®¡ç®—ç»„ä»¶ä½ç½®å¹¶æ’åˆ—å­ç»„ä»¶ |
| `LayoutAlgorithm::Layout` | ç®—æ³•å±‚ | å¸ƒå±€ç®—æ³• | å…·ä½“çš„å¸ƒå±€ç®—æ³•å®ç° |
| `OnLayoutFinish` | æ‰§è¡Œå±‚ | å®Œæˆå¤„ç†è€… | å¸ƒå±€å®Œæˆåçš„å›è°ƒå¤„ç† |
| `SavePaintRect` | æ¸²æŸ“å±‚ | åŒºåŸŸä¿å­˜è€… | ä¿å­˜ç»˜åˆ¶åŒºåŸŸåˆ°æ¸²æŸ“ä¸Šä¸‹æ–‡ |
| `AddSyncGeometryNodeTask` | è°ƒåº¦å±‚ | ä»»åŠ¡æ”¶é›†è€… | æ·»åŠ åŒæ­¥ä»»åŠ¡åˆ°é˜Ÿåˆ— |
| `FlushSyncGeometryNodeTasks` | è°ƒåº¦å±‚ | æ‰¹é‡åŒæ­¥è€… | æ‰¹é‡æ‰§è¡Œå‡ ä½•èŠ‚ç‚¹åŒæ­¥ä»»åŠ¡ |
| `ExpandSafeArea` | åŠŸèƒ½å±‚ | åŒºåŸŸæ‰©å±•è€… | æ‰©å±•ç»„ä»¶åˆ°å®‰å…¨åŒºåŸŸ |
| `SyncGeometryNode` | åŒæ­¥å±‚ | èŠ‚ç‚¹åŒæ­¥è€… | åŒæ­¥å‡ ä½•æ•°æ®åˆ°æ¸²æŸ“å¼•æ“ |
| `SyncGeometryProperties` | åŒæ­¥å±‚ | å±æ€§åŒæ­¥è€… | åŒæ­¥å‡ ä½•å±æ€§åˆ° RS èŠ‚ç‚¹ |
| `FlushRenderTask` | æ¸²æŸ“å±‚ | æ¸²æŸ“æ‰§è¡Œè€… | æ‰§è¡Œæ¸²æŸ“ä»»åŠ¡(é€æ˜¾) |

---

## æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. Dirty æ ‡è®°ä¼˜åŒ–

**åŸç†**: åªå¤„ç†æ ‡è®°ä¸º dirty çš„èŠ‚ç‚¹

**å®ç°ä½ç½®**: `frame_node.cpp:2545-2547`

```cpp
if (!isLayoutDirtyMarked_ && (layoutTaskType == LayoutType::NONE)) {
    return;  // é dirty èŠ‚ç‚¹è·³è¿‡
}
```

**ä¼˜åŒ–æ•ˆæœ**:
- å‡å°‘ä¸å¿…è¦çš„å¸ƒå±€è®¡ç®—
- é™ä½ CPU å ç”¨
- æå‡å¸ƒå±€å“åº”é€Ÿåº¦

**è§¦å‘æ¡ä»¶**:
- èŠ‚ç‚¹å±æ€§å˜åŒ–æ—¶ä¼šæ ‡è®° `isLayoutDirtyMarked_ = true`
- çˆ¶èŠ‚ç‚¹ dirty å¯èƒ½è§¦å‘å­èŠ‚ç‚¹ dirty

---

### 2. çº¦æŸæœªå˜åŒ–ä¼˜åŒ–

**åŸç†**: çº¦æŸæœªå˜åŒ–ä¸”æœªå¼ºåˆ¶æµ‹é‡æ—¶è·³è¿‡æµ‹é‡

**å®ç°ä½ç½®**: `frame_node.cpp:5606-5618`

```cpp
isConstraintNotChanged_ = layoutProperty_->ConstraintEqual(preConstraint, contentConstraint);

if (isConstraintNotChanged_) {
    if (!CheckNeedForceMeasureAndLayout()) {
        layoutAlgorithm_->SetSkipMeasure();
        return;  // è·³è¿‡æµ‹é‡
    }
}
```

**ä¼˜åŒ–æ•ˆæœ**:
- é¿å…é‡å¤æµ‹é‡
- å‡å°‘ç®—æ³•æ‰§è¡Œæ¬¡æ•°
- æå‡å¸ƒå±€æ•ˆç‡

**åˆ¤æ–­ä¾æ®**:
- å½“å‰çº¦æŸä¸ä¸Šæ¬¡çº¦æŸç›¸ç­‰
- æ— å¼ºåˆ¶æµ‹é‡æ ‡å¿—

---

### 3. SkipMeasure å’Œ SkipLayout

**åŸç†**: åˆ†åˆ«æ§åˆ¶æµ‹é‡å’Œå¸ƒå±€é˜¶æ®µçš„è·³è¿‡

**å®ç°ä½ç½®**: `frame_node.cpp:5572-5577, 5708-5745`

```cpp
// æµ‹é‡é˜¶æ®µ
if (layoutAlgorithm_->SkipMeasure()) {
    isLayoutDirtyMarked_ = false;
    return;  // è·³è¿‡æµ‹é‡
}

// å¸ƒå±€é˜¶æ®µ
if (!CheckNeedLayout(layoutProperty_->GetPropertyChangeFlag())) {
    layoutAlgorithm_->SetSkipLayout();
    return;  // è·³è¿‡å¸ƒå±€
}
```

**ä¼˜åŒ–æ•ˆæœ**:
- æµ‹é‡å’Œå¸ƒå±€å¯ä»¥ç‹¬ç«‹ä¼˜åŒ–
- ç»†ç²’åº¦æ§åˆ¶å¸ƒå±€æµç¨‹
- æœ€å¤§åŒ–å¤ç”¨å·²æœ‰ç»“æœ

**ä½¿ç”¨åœºæ™¯**:
- çº¦æŸæœªå˜åŒ– â†’ SkipMeasure
- å°ºå¯¸æœªå˜åŒ– â†’ SkipLayout
- å­ç»„ä»¶æœªå˜åŒ– â†’ SkipLayout

---

### 4. å®‰å…¨åŒºåŸŸæ‰©å±•ç¼“å­˜

**åŸç†**: ä½¿ç”¨ç¼“å­˜é¿å…é‡å¤è®¡ç®—å®‰å…¨åŒºåŸŸæ‰©å±•

**å®ç°ä½ç½®**: `layout_wrapper.cpp:376-420`

```cpp
bool LayoutWrapper::AccumulateExpandCacheHit(ExpandEdges& totalExpand, ...)
{
    auto& selfAccumulateExpand = geometryNode->GetAccumulatedSafeAreaExpand();
    if (selfAccumulateExpand->OptionalValueCover(totalExpand)) {
        // ä½¿ç”¨ç¼“å­˜ç»“æœ
        totalExpand += *selfAccumulateExpand;
        return true;
    }
    return false;
}
```

**ä¼˜åŒ–æ•ˆæœ**:
- å‡å°‘å®‰å…¨åŒºåŸŸè®¡ç®—å¼€é”€
- é¿å…é‡å¤éå†çˆ¶èŠ‚ç‚¹é“¾
- æå‡å¸ƒå±€æ€§èƒ½

**ç¼“å­˜æ¡ä»¶**:
- çˆ¶èŠ‚ç‚¹å·²æœ‰ç¼“å­˜è¦†ç›–å­èŠ‚ç‚¹æ‰©å±•æ–¹å‘
- PaddingBorder ä¸ºé›¶

---

### 5. æ‰¹é‡åŒæ­¥ä¼˜åŒ–

**åŸç†**: æ‰¹é‡æ‰§è¡ŒåŒæ­¥ä»»åŠ¡å‡å°‘å¼€é”€

**å®ç°ä½ç½®**: `ui_task_scheduler.cpp:116-127`

```cpp
void UITaskScheduler::FlushSyncGeometryNodeTasks()
{
    auto tasks = std::move(syncGeometryNodeTasks_);
    for (auto& task : tasks) {
        if (task) {
            task();  // æ‰¹é‡æ‰§è¡Œ
        }
    }
}
```

**ä¼˜åŒ–æ•ˆæœ**:
- å‡å°‘ä»»åŠ¡è°ƒåº¦å¼€é”€
- æé«˜æ‰§è¡Œæ•ˆç‡
- ä¾¿äºä¼˜åŒ–åŒæ­¥ç­–ç•¥

**ä¼˜åŠ¿**:
- ä»»åŠ¡é›†ä¸­æ‰§è¡Œ,å‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢
- ä¾¿äºå®ç°åŒæ­¥ç­–ç•¥ä¼˜åŒ–
- æ”¯æŒä»»åŠ¡ä¼˜å…ˆçº§æ’åº

---

### 6. å¢é‡å¸ƒå±€

**åŸç†**: åªå¸ƒå±€å˜åŒ–çš„å­ç»„ä»¶

**å®ç°**: ç»„ä»¶çº§åˆ«æ”¯æŒ,ç”±å„ Pattern å®ç°

**ç¤ºä¾‹**: Flex ç»„ä»¶çš„å¢é‡å¸ƒå±€

**ä¼˜åŒ–æ•ˆæœ**:
- å¤§å¹…å‡å°‘å¸ƒå±€è®¡ç®—é‡
- æå‡å¤æ‚åœºæ™¯æ€§èƒ½
- é™ä½å¸ƒå±€è€—æ—¶

**é€‚ç”¨åœºæ™¯**:
- åˆ—è¡¨æ»šåŠ¨
- åŠ¨æ€å†…å®¹æ›´æ–°
- å±€éƒ¨åˆ·æ–°

---

## è°ƒè¯•æŒ‡å—

### è°ƒè¯•è¿½è¸ªå¼€å…³

#### 1. å¸ƒå±€è¿½è¸ª

**ä½ç½®**: `frame_node.cpp:5540`

```cpp
ACE_LAYOUT_TRACE_BEGIN("Measure[%s][self:%d][parent:%d][key:%s]", ...);
// ... å¸ƒå±€ä»£ç 
ACE_LAYOUT_TRACE_END()
```

**ä½¿ç”¨æ–¹æ³•**: ç¼–è¯‘æ—¶å¯ç”¨ `ACE_LAYOUT_TRACE` å®

**è¾“å‡ºå†…å®¹**:
- èŠ‚ç‚¹æ ‡ç­¾ã€IDã€çˆ¶èŠ‚ç‚¹IDã€Inspector ID
- æµ‹é‡å’Œå¸ƒå±€è€—æ—¶
- çº¦æŸä¿¡æ¯

---

#### 2. æµ‹é‡è°ƒè¯•è¿½è¸ª

**ä½ç½®**: `frame_node.cpp:5542-5548`

```cpp
if (SystemProperties::GetMeasureDebugTraceEnabled()) {
    ACE_MEASURE_SCOPED_TRACE("MeasureInfo[frameRect:%s][parentConstraint:%s][calcConstraint:%s]",
        GetGeometryNode()->GetFrameRect().ToString().c_str(),
        parentConstraint.has_value() ? parentConstraint.value().ToString().c_str() : "NA",
        layoutProperty_->GetCalcLayoutConstraint() ?
            layoutProperty_->GetCalcLayoutConstraint()->ToString().c_str() : "NA");
}
```

**ä½¿ç”¨æ–¹æ³•**: è¿è¡Œæ—¶è®¾ç½® `SystemProperties::GetMeasureDebugTraceEnabled() = true`

**è¾“å‡ºå†…å®¹**:
- æ¡†æ¶çŸ©å½¢ä¿¡æ¯
- çˆ¶èŠ‚ç‚¹çº¦æŸä¿¡æ¯
- è®¡ç®—çº¦æŸä¿¡æ¯

---

#### 3. åŒæ­¥è°ƒè¯•è¿½è¸ª

**ä½ç½®**: `frame_node.cpp:5969-5974`

```cpp
if (SystemProperties::GetSyncDebugTraceEnabled()) {
    ACE_LAYOUT_TRACE_BEGIN("SyncGeometryNode[%s][self:%d][parent:%d][key:%s][paintRect:%s][needSyncRsNode:%d]",
        tag_.c_str(), nodeId_, ..., renderContext_->GetPaintRectWithoutTransform().ToString().c_str(), needSyncRsNode);
    ACE_LAYOUT_TRACE_END()
}
```

**ä½¿ç”¨æ–¹æ³•**: è¿è¡Œæ—¶è®¾ç½® `SystemProperties::GetSyncDebugTraceEnabled() = true`

**è¾“å‡ºå†…å®¹**:
- åŒæ­¥èŠ‚ç‚¹ä¿¡æ¯
- ç»˜åˆ¶çŸ©å½¢ä¿¡æ¯
- æ˜¯å¦éœ€è¦åŒæ­¥ RS èŠ‚ç‚¹

---

#### 4. å®‰å…¨åŒºåŸŸè°ƒè¯•è¿½è¸ª

**ä½ç½®**: `layout_wrapper.cpp:289-294`

```cpp
if (SystemProperties::GetSafeAreaDebugTraceEnabled()) {
    ACE_SAFE_AREA_SCOPED_TRACE("ExpandSafeAreaFinish[%s][self:%d][parent:%d][key:%s][paintRectRect:%s][selfAdjust:%s]",
        host->GetTag().c_str(), host->GetId(), ..., renderContext->GetPaintRectWithoutTransform().ToString().c_str(),
        selfAdjust.ToString().c_str());
}
```

**ä½¿ç”¨æ–¹æ³•**: è¿è¡Œæ—¶è®¾ç½® `SystemProperties::GetSafeAreaDebugTraceEnabled() = true`

**è¾“å‡ºå†…å®¹**:
- å®‰å…¨åŒºåŸŸæ‰©å±•ä¿¡æ¯
- ç»˜åˆ¶çŸ©å½¢å˜åŒ–
- è‡ªè°ƒæ•´é‡ä¿¡æ¯

---

### å¸¸ç”¨è°ƒè¯•å‘½ä»¤

#### æŸ¥çœ‹ dirty èŠ‚ç‚¹

```bash
# æ·»åŠ æ—¥å¿—åˆ° UITaskScheduler::FlushLayoutTask
# æŸ¥çœ‹æœ‰å¤šå°‘ dirty èŠ‚ç‚¹
```

#### è¿½è¸ªå•ä¸ªèŠ‚ç‚¹çš„å¸ƒå±€

```bash
# åœ¨ FrameNode::Measure/Layout å¼€å§‹å¤„æ·»åŠ æ¡ä»¶æ–­ç‚¹
# æ¡ä»¶: nodeId_ == <ç›®æ ‡èŠ‚ç‚¹ID>
```

#### æŸ¥çœ‹å¸ƒå±€çº¦æŸ

```bash
# åœ¨ FrameNode::Measure ä¸­æŸ¥çœ‹ parentConstraint
# åœ¨ FrameNode::Layout ä¸­æŸ¥çœ‹ layoutProperty_->GetLayoutConstraint()
```

#### æŸ¥çœ‹å®‰å…¨åŒºåŸŸæ‰©å±•

```bash
# åœ¨ LayoutWrapper::ExpandSafeArea ä¸­æ·»åŠ æ—¥å¿—
# æŸ¥çœ‹ optsã€frameã€selfAdjust ç­‰å…³é”®å˜é‡
```

---

### æ€§èƒ½åˆ†æ

#### å¸ƒå±€è€—æ—¶åˆ†æ

**å·¥å…·**: ACE_LAYOUT_TRACE

**æ–¹æ³•**:
1. å¯ç”¨å¸ƒå±€è¿½è¸ª
2. æŸ¥çœ‹æ—¥å¿—è¾“å‡º
3. åˆ†æå„é˜¶æ®µè€—æ—¶

**å…³é”®æŒ‡æ ‡**:
- Measure è€—æ—¶
- Layout è€—æ—¶
- SyncGeometryNode è€—æ—¶
- ExpandSafeArea è€—æ—¶

---

#### å¸ƒå±€æ¬¡æ•°åˆ†æ

**å·¥å…·**: æ—¥å¿—ç»Ÿè®¡

**æ–¹æ³•**:
1. åœ¨ `FlushTask` ä¸­æ·»åŠ è®¡æ•°å™¨
2. ç»Ÿè®¡æ¯å¸§çš„å¸ƒå±€æ¬¡æ•°
3. åˆ†ææ˜¯å¦å­˜åœ¨è¿‡å¤šæ¬¡å¸ƒå±€

**å¼‚å¸¸æƒ…å†µ**:
- å•å¸§å¸ƒå±€æ¬¡æ•° > 2
- æŸä¸ªèŠ‚ç‚¹åå¤å¸ƒå±€
- å¸ƒå±€å¾ªç¯

---

#### å†…å­˜å ç”¨åˆ†æ

**å·¥å…·**: å†…å­˜åˆ†æå·¥å…·

**å…³é”®æŒ‡æ ‡**:
- LayoutWrapper æ•°é‡
- GeometryNode æ•°é‡
- LayoutAlgorithm æ•°é‡

**ä¼˜åŒ–æ–¹å‘**:
- åŠæ—¶æ¸…ç†è¿‡æœŸå¯¹è±¡
- å¤ç”¨ LayoutAlgorithm
- å‡å°‘ä¸å¿…è¦çš„ GeometryNode åˆ›å»º

---

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆéœ€è¦å¤šæ¬¡å¸ƒå±€?

**åœºæ™¯**:
- **å‡ ä½•è¿‡æ¸¡åŠ¨ç”»**: éœ€è¦åœ¨åŠ¨ç”»è¿‡ç¨‹ä¸­å¤šæ¬¡å¸ƒå±€ä»¥æ›´æ–°ä½ç½®
- **å¢é‡å¸ƒå±€**: ç¬¬ä¸€æ¬¡å¸ƒå±€å¯èƒ½è§¦å‘å­ç»„ä»¶éœ€è¦é‡æ–°å¸ƒå±€
- **å®‰å…¨åŒºåŸŸæ‰©å±•**: æ‰©å±•åå¯èƒ½éœ€è¦é‡æ–°å¸ƒå±€ç›¸å…³èŠ‚ç‚¹

**å®ç°æœºåˆ¶**:
```cpp
void UITaskScheduler::FlushTask()
{
    do {
        FlushLayoutTask();
        if (NeedAdditionalLayout()) {
            FlushLayoutTask();
        }
        layoutedCount++;
        multiLayoutCount_--;
    } while (multiLayoutCount_ > 0);
}
```

**æ§åˆ¶ç­–ç•¥**:
- æœ€å¤šæ‰§è¡Œ `ENDORSE_LAYOUT_COUNT`(2) æ¬¡åè¯·æ±‚ä¸‹ä¸€å¸§ç»§ç»­
- é€šè¿‡ `multiLayoutCount_` æ§åˆ¶å¸ƒå±€æ¬¡æ•°
- é¿å…æ— é™å¾ªç¯

---

### Q2: SkipMeasure å’Œ SkipLayout çš„åŒºåˆ«?

**åŒºåˆ«**:

| ç‰¹æ€§ | SkipMeasure | SkipLayout |
|------|-------------|------------|
| **è·³è¿‡é˜¶æ®µ** | æµ‹é‡é˜¶æ®µ | å¸ƒå±€é˜¶æ®µ |
| **å¤ç”¨å†…å®¹** | å¤ç”¨æµ‹é‡ç»“æœ | å¤ç”¨å¸ƒå±€ç»“æœ |
| **è§¦å‘æ¡ä»¶** | çº¦æŸæœªå˜åŒ– | å°ºå¯¸æœªå˜åŒ– |
| **å½±å“èŒƒå›´** | ä¸å½±å“å­ç»„ä»¶æµ‹é‡ | ä¸å½±å“å­ç»„ä»¶å¸ƒå±€ |

**ç‹¬ç«‹æ€§**: ä¸¤è€…å¯ä»¥ç‹¬ç«‹è§¦å‘,å®ç°ç»†ç²’åº¦ä¼˜åŒ–

**ä½¿ç”¨åœºæ™¯**:
- çº¦æŸæœªå˜åŒ– â†’ SkipMeasure
- å°ºå¯¸æœªå˜åŒ– â†’ SkipLayout
- ä¸¤è€…åŒæ—¶æ»¡è¶³ â†’ å®Œå…¨è·³è¿‡å¸ƒå±€æµç¨‹

---

### Q3: å®‰å…¨åŒºåŸŸæ‰©å±•ä½•æ—¶æ‰§è¡Œ?

**æ‰§è¡Œæ—¶æœº**:
```
1. æ‰€æœ‰èŠ‚ç‚¹çš„ Measure å’Œ Layout å®Œæˆå
2. åœ¨ FlushSyncGeometryNodeTasks é˜¶æ®µ
3. åœ¨åŒæ­¥å‡ ä½•èŠ‚ç‚¹ä¹‹å‰
```

**åŸå› **:
1. **ç»Ÿä¸€å¤„ç†**: åœ¨ç»Ÿä¸€çš„æ—¶æœºå¤„ç†æ‰€æœ‰éœ€è¦æ‰©å±•çš„èŠ‚ç‚¹
2. **é¿å…é‡å¤**: é¿å…é‡å¤è®¡ç®—å’ŒåŒæ­¥
3. **æœ€ç»ˆä½ç½®**: ç¡®ä¿åŒæ­¥çš„ä½ç½®æ˜¯æœ€ç»ˆä½ç½®(åŒ…æ‹¬å®‰å…¨åŒºåŸŸæ‰©å±•)

**æ‰§è¡Œæµç¨‹**:
```
FlushLayoutTask (å®Œæˆæ‰€æœ‰æµ‹é‡å’Œå¸ƒå±€)
  â””â”€> FlushSyncGeometryNodeTasks
       â”œâ”€> ExpandSafeArea (ç»Ÿä¸€æ‰©å±•å®‰å…¨åŒºåŸŸ)
       â””â”€> æ‰§è¡ŒåŒæ­¥ä»»åŠ¡ (åŒæ­¥æœ€ç»ˆä½ç½®)
```

---

### Q4: å‡ ä½•èŠ‚ç‚¹åŒæ­¥ä»»åŠ¡ä¸ºä»€ä¹ˆè¦å»¶è¿Ÿæ‰§è¡Œ?

**åŸå› **:
1. **æ‰¹é‡å¤„ç†**: å¯ä»¥æ‰¹é‡å¤„ç†å¤šä¸ªèŠ‚ç‚¹çš„åŒæ­¥ä»»åŠ¡,å‡å°‘å¼€é”€
2. **é¿å…é‡å¤**: å¦‚æœèŠ‚ç‚¹åœ¨åç»­å¸ƒå±€ä¸­å†æ¬¡å˜åŒ–,é¿å…é‡å¤åŒæ­¥
3. **å®‰å…¨åŒºåŸŸ**: å…ˆç»Ÿä¸€æ‰©å±•å®‰å…¨åŒºåŸŸ,å†åŒæ­¥,ç¡®ä¿åŒæ­¥çš„ä½ç½®æ˜¯æœ€ç»ˆä½ç½®
4. **æ€§èƒ½ä¼˜åŒ–**: å‡å°‘åŒæ­¥æ¬¡æ•°,æå‡æ€§èƒ½

**å®ç°æœºåˆ¶**:
```cpp
// FrameNode::Layout
auto task = [weak = WeakClaim(this), needSync, dirtyConfig]() {
    auto frameNode = weak.Upgrade();
    CHECK_NULL_VOID(frameNode);
    frameNode->SyncGeometryNode(needSync, dirtyConfig);
};
pipeline->AddSyncGeometryNodeTask(task);  // æ·»åŠ åˆ°é˜Ÿåˆ—

// UITaskScheduler::FlushTask
FlushLayoutTask();  // å…ˆå®Œæˆæ‰€æœ‰å¸ƒå±€
FlushSyncGeometryNodeTasks();  // å†æ‰¹é‡åŒæ­¥
```

---

### Q5: å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦éœ€è¦åŒæ­¥åˆ°æ¸²æŸ“å¼•æ“?

**åˆ¤æ–­ä½ç½®**: `FrameNode::OnLayoutFinish`

**åˆ¤æ–­æ¡ä»¶**:
```cpp
needSyncRsNode = frameSizeChange || frameOffsetChange ||
                 contentSizeChange || HasPositionProp() || SelfOrParentExpansive();
```

**åŒ…æ‹¬ä»¥ä¸‹æƒ…å†µ**:
- **æ¡†æ¶å°ºå¯¸å˜åŒ–**: frameSizeChange
- **æ¡†æ¶ä½ç½®å˜åŒ–**: frameOffsetChange
- **å†…å®¹å°ºå¯¸å˜åŒ–**: contentSizeChange (æœ‰ä¸Šä¸‹æ–‡å‚æ•°æ—¶)
- **æœ‰ä½ç½®å±æ€§**: HasPositionProp()
- **è‡ªèº«æˆ–çˆ¶èŠ‚ç‚¹éœ€è¦æ‰©å±•åˆ°å®‰å…¨åŒºåŸŸ**: SelfOrParentExpansive()

**ä¼˜åŒ–ç­–ç•¥**:
- åªåœ¨å¿…è¦æ—¶åŒæ­¥
- é¿å…æ— æ„ä¹‰çš„åŒæ­¥å¼€é”€
- æå‡æ¸²æŸ“æ€§èƒ½

---

### Q6: LayoutWrapper å’Œ FrameNode çš„å…³ç³»?

**å…³ç³»**:

| ç‰¹æ€§ | FrameNode | LayoutWrapper |
|------|-----------|---------------|
| **å®šä½** | ç»„ä»¶èŠ‚ç‚¹çš„å®Œæ•´è¡¨ç¤º | å¸ƒå±€æ•°æ®çš„åŒ…è£…å™¨ |
| **åŒ…å«å†…å®¹** | Pattern, Property, EventHub, GeometryNode ç­‰ | åªåŒ…å«å¸ƒå±€ç›¸å…³çš„æ•°æ® |
| **ç”Ÿå‘½å‘¨æœŸ** | ç»„ä»¶å­˜åœ¨æœŸé—´ä¸€ç›´å­˜åœ¨ | åªåœ¨å¸ƒå±€æœŸé—´åˆ›å»º |
| **å†…å­˜å ç”¨** | è¾ƒå¤§ | è¾ƒå°(è½»é‡çº§) |

**ä½¿ç”¨åœºæ™¯**:
- **FrameNode**: ç»„ä»¶çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸç®¡ç†
- **LayoutWrapper**: å¸ƒå±€æµç¨‹ä¸­çš„æ•°æ®ä¼ é€’

**ä¼˜åŠ¿**:
- å‡å°‘å¸ƒå±€è¿‡ç¨‹ä¸­çš„æ•°æ®ä¾èµ–
- æä¾›å¸ƒå±€ç®—æ³•çš„ç»Ÿä¸€æ¥å£
- ä¼˜åŒ–å¸ƒå±€æ€§èƒ½

---

### Q7: å¦‚ä½•æ·»åŠ è‡ªå®šä¹‰å¸ƒå±€ç®—æ³•?

**æ­¥éª¤**:

1. **åˆ›å»ºå¸ƒå±€ç®—æ³•ç±»**
```cpp
class MyLayoutAlgorithm : public LayoutAlgorithm {
public:
    void Measure(LayoutWrapper* layoutWrapper) override {
        // æµ‹é‡é€»è¾‘
    }

    void Layout(LayoutWrapper* layoutWrapper) override {
        // å¸ƒå±€é€»è¾‘
    }
};
```

2. **åœ¨ Pattern ä¸­åˆ›å»ºç®—æ³•**
```cpp
class MyPattern : public Pattern {
    RefPtr<LayoutAlgorithm> CreateLayoutAlgorithm() override {
        return MakeRefPtr<MyLayoutAlgorithm>();
    }
};
```

3. **æ¡†æ¶è‡ªåŠ¨è°ƒç”¨**
- FrameNode::Measure ä¼šè°ƒç”¨ GetLayoutAlgorithm
- GetLayoutAlgorithm ä¼šè°ƒç”¨ Pattern::CreateLayoutAlgorithm
- è‡ªåŠ¨æ‰§è¡Œç®—æ³•çš„ Measure å’Œ Layout æ–¹æ³•

---

### Q8: å¦‚ä½•è°ƒè¯•å¸ƒå±€é—®é¢˜?

**è°ƒè¯•æ­¥éª¤**:

1. **å¯ç”¨è°ƒè¯•è¿½è¸ª**
```cpp
SystemProperties::SetMeasureDebugTraceEnabled(true);
SystemProperties::SetSyncDebugTraceEnabled(true);
```

2. **æŸ¥çœ‹æ—¥å¿—è¾“å‡º**
- Measure æ—¥å¿—: æŸ¥çœ‹çº¦æŸå’Œå°ºå¯¸
- Layout æ—¥å¿—: æŸ¥çœ‹ä½ç½®ä¿¡æ¯
- Sync æ—¥å¿—: æŸ¥çœ‹åŒæ­¥ä¿¡æ¯

3. **æ·»åŠ æ–­ç‚¹**
- FrameNode::Measure: æµ‹é‡é˜¶æ®µ
- FrameNode::Layout: å¸ƒå±€é˜¶æ®µ
- FrameNode::OnLayoutFinish: å®Œæˆé˜¶æ®µ

4. **æ£€æŸ¥å…³é”®æ•°æ®**
- å¸ƒå±€çº¦æŸ: LayoutProperty::GetLayoutConstraint()
- æµ‹é‡ç»“æœ: GeometryNode::GetFrameSize()
- å¸ƒå±€ç»“æœ: GeometryNode::GetFrameOffset()

---

## é™„å½•

### ç›¸å…³æ–‡æ¡£

- **[Text ç»„ä»¶çŸ¥è¯†åº“](../pattern/text/Text_Knowledge_Base_CN.md)**: Text ç»„ä»¶çš„å¸ƒå±€å®ç°
- **[Flex ç»„ä»¶çŸ¥è¯†åº“](../pattern/flex/Flex_Knowledge_Base.md)**: Flex å¸ƒå±€çš„è¯¦ç»†å®ç°
- **[Scroll ç»„ä»¶çŸ¥è¯†åº“](../pattern/scroll/Scroll_Knowledge_Base.md)**: æ»šåŠ¨å¸ƒå±€çš„ç‰¹æ®Šå¤„ç†
- **[ArkUI SDK API çŸ¥è¯†åº“](../sdk/ArkUI_SDK_API_Knowledge_Base.md)**: SDK API çš„å¸ƒå±€ç›¸å…³æ¥å£

### æºç è·¯å¾„æ±‡æ€»

| æ–‡ä»¶ | è·¯å¾„ | ä½œç”¨ |
|------|------|------|
| ä»»åŠ¡è°ƒåº¦å™¨ | `frameworks/core/pipeline_ng/ui_task_scheduler.cpp` | ä»»åŠ¡è°ƒåº¦å’Œç®¡ç† |
| å¸§èŠ‚ç‚¹ | `frameworks/core/components_ng/base/frame_node.cpp` | ç»„ä»¶èŠ‚ç‚¹å¸ƒå±€æ‰§è¡Œä¸»ä½“ |
| å¸ƒå±€åŒ…è£…å™¨ | `frameworks/core/components_ng/layout/layout_wrapper.cpp` | å¸ƒå±€æ•°æ®åŒ…è£…å’Œä¼ é€’ |
| å¸ƒå±€ç®—æ³• | `frameworks/core/components_ng/layout/layout_algorithm.cpp` | å¸ƒå±€ç®—æ³•åŸºç¡€å®ç° |
| ç®¡é“ä¸Šä¸‹æ–‡ | `frameworks/core/pipeline_ng/pipeline_context.cpp` | ç®¡é“ä¸Šä¸‹æ–‡,è§¦å‘å¸ƒå±€ |

### å…³é”®ç±»æ±‡æ€»

| ç±»å | å¤´æ–‡ä»¶ | ä½œç”¨ |
|------|--------|------|
| UITaskScheduler | `ui_task_scheduler.h` | UI ä»»åŠ¡è°ƒåº¦å™¨ |
| FrameNode | `frame_node.h` | ç»„ä»¶èŠ‚ç‚¹ |
| LayoutWrapper | `layout_wrapper.h` | å¸ƒå±€åŒ…è£…å™¨ |
| LayoutAlgorithm | `layout_algorithm.h` | å¸ƒå±€ç®—æ³•åŸºç±» |
| LayoutAlgorithmWrapper | `layout_algorithm.h` | å¸ƒå±€ç®—æ³•åŒ…è£…å™¨ |
| GeometryNode | `geometry_node.h` | å‡ ä½•èŠ‚ç‚¹ |
| LayoutProperty | `layout_property.h` | å¸ƒå±€å±æ€§ |
| SafeAreaManager | `safe_area_manager.h` | å®‰å…¨åŒºåŸŸç®¡ç†å™¨ |

### å¸ƒå±€ç›¸å…³å®å®šä¹‰

| å®åç§° | ä½œç”¨ | å®šä¹‰ä½ç½® |
|--------|------|----------|
| ACE_LAYOUT_TRACE | å¸ƒå±€è¿½è¸ª | `ace_trace.h` |
| ACE_SCOPED_TRACE | ä½œç”¨åŸŸè¿½è¸ª | `ace_trace.h` |
| ENDORSE_LAYOUT_COUNT | æœ€å¤§å¸ƒå±€æ¬¡æ•° | `ui_task_scheduler.cpp` |

---

**æ–‡æ¡£ç»´æŠ¤**: æœ¬æ–‡æ¡£åº”éšä»£ç å˜æ›´åŒæ­¥æ›´æ–°,ç¡®ä¿å‡†ç¡®åæ˜ å½“å‰å®ç°ã€‚
